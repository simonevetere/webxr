<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <link rel='stylesheet' href='css/common.css'>
    <title>AR QR-Tracking Sunflower - Posizionato Sopra</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>QR Tracking Verticale</summary>
        <p>Il girasole appare ora sopra il bordo superiore del QR code verticale.</p>
      </details>
    </header>
    <script type="module">
      import {WebXRButton} from './js/util/webxr-button.js';
      import {Scene} from './js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
      import {Node} from './js/render/core/node.js'; 
      import {Gltf2Node} from './js/render/nodes/gltf2.js';
      import {QueryArgs} from './js/util/query-args.js';

      let xrButton = null;
      let xrImmersiveRefSpace = null;
      let gl = null;
      let renderer = null;
      let scene = new Scene();
      scene.enableStats(false);

      // 1. Creiamo il contenitore che seguirà il QR code
      let trackingNode = new Node();
      trackingNode.visible = false;
      scene.addNode(trackingNode);

      // 2. Carichiamo il girasole
      let sunflower = new Gltf2Node({url: 'media/gltf/sunflower/sunflower.gltf'});
      
      // --- MODIFICHE QUI ---
      
      // SCALA: Lo rimpiccioliamo
      sunflower.scale = [0.1, 0.1, 0.1]; 

      // POSIZIONE (TRANSLATION):
      // Lo spostiamo di 2.5 cm (0.025m) verso l'alto (asse Y) rispetto al centro del QR.
      // Dato che il QR è alto 5cm, questo lo posiziona esattamente sul bordo superiore.
      sunflower.translation = [0, 0.025, 0];

      // ROTAZIONE:
      // Lo ruotiamo di -90 gradi sull'asse X per farlo stare "in piedi" verticalmente.
      sunflower.rotation = [-Math.PI / 2, 0, 0];

      // ---------------------
      
      trackingNode.addNode(sunflower);

      async function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: (session) => session.end()
        });
        document.querySelector('header').appendChild(xrButton.domElement);

        if (navigator.xr) {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          xrButton.enabled = supported;
        }
      }

      async function onRequestSession() {
        const img = document.createElement('img');
        img.src = 'media/textures/qr-code.png'; 
        await img.decode();
        const bitmap = await createImageBitmap(img);

        return navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['image-tracking'],
          trackedImages: [{
            image: bitmap,
            widthInMeters: 0.05 // Larghezza reale del QR (5cm)
          }]
        }).then((session) => {
          xrButton.setSession(session);
          onSessionStarted(session);
        });
      }

      function onSessionStarted(session) {
        initGL();
        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
        session.requestReferenceSpace('local').then((refSpace) => {
          xrImmersiveRefSpace = refSpace;
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function initGL() {
        if (gl) return;
        gl = createWebGLContext({ xrCompatible: true });
        renderer = new Renderer(gl);
        scene.setRenderer(renderer);
      }

      function onXRFrame(t, frame) {
        let session = frame.session;
        session.requestAnimationFrame(onXRFrame);
        let pose = frame.getViewerPose(xrImmersiveRefSpace);

        const results = frame.getImageTrackingResults();
        for (const result of results) {
          if (result.trackingState == 'tracked') {
            const imagePose = frame.getPose(result.imageSpace, xrImmersiveRefSpace);
            if (imagePose) {
              // Muoviamo il CONTENITORE
              trackingNode.visible = true;
              trackingNode.matrix = imagePose.transform.matrix;
            }
          } else {
            trackingNode.visible = false;
          }
        }

        scene.startFrame();
        scene.drawXRFrame(frame, pose);
        scene.endFrame();
      }

      initXR();
    </script>
  </body>
</html>
