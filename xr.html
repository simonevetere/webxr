<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>

    <title>Immersive AR - Oggetto Singolo</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>Sessione AR Pulita</summary>
        <p>
          In questa versione l'oggetto è centrato e i dati FPS sono nascosti.
          <a class="back" href="./">Indietro</a>
        </p>
      </details>
    </header>
    <script type="module">
      import {WebXRButton} from './js/util/webxr-button.js';
      import {Scene} from './js/render/scenes/scene.js';
      import {Renderer, createWebGLContext} from './js/render/core/renderer.js';
      import {Gltf2Node} from './js/render/nodes/gltf2.js';
      import {InlineViewerHelper} from './js/util/inline-viewer-helper.js';
      import {QueryArgs} from './js/util/query-args.js';
      import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';

      if (QueryArgs.getBool('usePolyfill', true)) {
        let polyfill = new WebXRPolyfill();
      }

      // Variabili globali
      let xrButton = null;
      let xrImmersiveRefSpace = null;
      let inlineViewerHelper = null;
      let gl = null;
      let renderer = null;

      // 1. Inizializzazione Scena
      let scene = new Scene();
      
      // --- RIGA PER TOGLIERE IL DISPLAY FPS ---
      scene.enableStats(false); 

      // 2. Caricamento Oggetto Singolo
      // Nota: se 'sunflower' non carica, usa 'media/gltf/space/space.gltf'
      let oggettoSingolo = new Gltf2Node({url: 'media/gltf/sunflower/sunflower.gltf'}); 
      
      // Posizionamento: [X, Y, Z] -> 0 (centro), -0.5 (altezza petto), -1 (1 metro avanti)
      oggettoSingolo.translation = [0, -0.5, -1]; 
      
      // Scala: 0.5 è il 50% della dimensione originale
      oggettoSingolo.scale = [0.5, 0.5, 0.5]; 
      
      scene.addNode(oggettoSingolo);

      // --- SKYBOX RIMOSSA PER AR PULITA ---

      function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession,
          textEnterXRTitle: "AVVIA AR",
          textXRNotFoundTitle: "AR NON DISPONIBILE",
          textExitXRTitle: "ESCI DA AR",
        });
        document.querySelector('header').appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            xrButton.enabled = supported;
          });
          navigator.xr.requestSession('inline').then(onSessionStarted);
        }
      }

      function onRequestSession() {
        return navigator.xr.requestSession('immersive-ar')
            .then((session) => {
              xrButton.setSession(session);
              session.isImmersive = true;
              onSessionStarted(session);
            });
      }

      function initGL() {
        if (gl) return;
        gl = createWebGLContext({ xrCompatible: true });
        document.body.appendChild(gl.canvas);

        function onResize() {
          gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
          gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
        }
        window.addEventListener('resize', onResize);
        onResize();

        renderer = new Renderer(gl);
        scene.setRenderer(renderer);
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);
        initGL();

        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

        let refSpaceType = session.isImmersive ? 'local' : 'viewer';
        session.requestReferenceSpace(refSpaceType).then((refSpace) => {
          if (session.isImmersive) {
            xrImmersiveRefSpace = refSpace;
          } else {
            inlineViewerHelper = new InlineViewerHelper(gl.canvas, refSpace);
          }
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        if (event.session.isImmersive) {
          xrButton.setSession(null);
        }
      }

      function onXRFrame(t, frame) {
        let session = frame.session;
        let refSpace = session.isImmersive ? xrImmersiveRefSpace : inlineViewerHelper.referenceSpace;
        let pose = frame.getViewerPose(refSpace);

        scene.startFrame();
        session.requestAnimationFrame(onXRFrame);
        scene.drawXRFrame(frame, pose);
        scene.endFrame();
      }

      initXR();
    </script>
  </body>
</html>
