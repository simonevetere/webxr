<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
  <title>Three.js - Head Tracking Panel</title>
  <link rel='stylesheet' href='./css/common.css'>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
  </script>
</head>
<body>
  <header style="pointer-events: none;">
    <details open>
      <summary>Pannello Follow-Face</summary>
      <p>Ti segue ovunque guardi. Afferralo per spostarlo manualmente.</p>
      <a class="back" href="./" style="pointer-events: auto;">Indietro</a>
    </details>
  </header>

  <script type="module">
    import * as THREE from 'three';
    import { ARButton } from 'three/addons/webxr/ARButton.js';
    import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

    // --- SETUP SCENA ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    document.body.appendChild(ARButton.createButton(renderer, { 
      optionalFeatures: ['hand-tracking'] 
    }));

    scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1));

    // --- CARICAMENTO TEXTURE (Eel/Subacquea) ---
    const textureLoader = new THREE.TextureLoader();
    const myTexture = textureLoader.load('./media/textures/rect-mono.png');

    // Pannello sottile 1cm con proporzioni corrette 1620x1080
    const geometry = new THREE.BoxGeometry(0.45, 0.30, 0.01);
    const material = new THREE.MeshBasicMaterial({ map: myTexture });
    const panel = new THREE.Mesh(geometry, material);
    scene.add(panel);

    // --- MANI ---
    const handModels = new XRHandModelFactory();
    const controllers = {
      left: { hand: renderer.xr.getHand(0), grabbed: null },
      right: { hand: renderer.xr.getHand(1), grabbed: null }
    };

    [controllers.left, controllers.right].forEach(c => {
      c.hand.add(handModels.createHandModel(c.hand, 'mesh'));
      scene.add(c.hand);
    });

    let activeGrab = null; // Indica se il pannello Ã¨ in mano a qualcuno

    function handleInteraction(controllerObj) {
      const hand = controllerObj.hand;
      const indexTip = hand.joints['index-finger-tip'];
      const thumbTip = hand.joints['thumb-tip'];

      if (!indexTip || !thumbTip || !indexTip.position) return;

      const distPinch = indexTip.position.distanceTo(thumbTip.position);
      
      if (distPinch < 0.035) { // Pizzicotto attivo
        const distToPanel = indexTip.position.distanceTo(panel.position);
        if (distToPanel < 0.25 || activeGrab) {
          activeGrab = true;
          panel.position.copy(indexTip.position);
          panel.quaternion.copy(indexTip.quaternion);
        }
      } else {
        activeGrab = false;
      }
    }

    // --- LOOP DI RENDERING ---
    renderer.setAnimationLoop(() => {
      
      // LOGICA FOLLOW-FACE: Se non lo stai afferrando, seguimi
      if (!activeGrab) {
        // Crea un punto 40cm davanti alla camera (il visore)
        const distance = 0.45; 
        const targetPos = new THREE.Vector3(0, 0, -distance);
        targetPos.applyMatrix4(camera.matrixWorld);

        // Copia posizione e rotazione della faccia (HUD mode)
        panel.position.lerp(targetPos, 0.1); // 0.1 per un movimento fluido, usa 1.0 per istantaneo
        panel.quaternion.slerp(camera.quaternion, 0.1);
      }

      handleInteraction(controllers.left);
      handleInteraction(controllers.right);
      
      renderer.render(scene, camera);
    });
  </script>
</body>
</html>